services:
  mysql:
    image: mysql:8.3.0
    container_name: mysql
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: password
      MYSQL_DATABASE: energy_tracker
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-uroot", "-ppassword"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 40s
    ports:
      - "3306:3306"
    volumes:
      - ./docker/mysql/init.sql:/docker-entrypoint-initdb.d/init.sql
      - db-data:/var/lib/mysql

  kafka:
    container_name: kafka
    image: apache/kafka:latest
    ports:
      - "9092:9092" # Internal listener
      - "9094:9094" # External listener
    
    environment:
      # ID for this Kafka node
      KAFKA_NODE_ID: 1
      # Kafka cluster identifier
      KAFKA_CLUSTER_ID: 'energy-tracker-cluster-1'
      # Node roles (instance will be a broker and controller)
      KAFKA_PROCESS_ROLES: 'broker,controller'

      # List of controller nodes that form the Raft quorum
      KAFKA_CONTROLLER_QUORUM_VOTERS: '1@kafka:9093'
      # Listener name used by controllers for internal Raft communication
      KAFKA_CONTROLLER_LISTENER_NAMES: 'CONTROLLER'

      # Define all listener endpoints for this Kafka node
      KAFKA_LISTENERS: >
        PLAINTEXT://0.0.0.0:9092,
        EXTERNAL://0.0.0.0:9094,
        CONTROLLER://0.0.0.0:9093

      # What each listener advertises to connecting clients
      # Internal (Docker containers): kafka:9092
      # External (host machine): localhost:9094
      KAFKA_ADVERTISED_LISTENERS: >
        PLAINTEXT://kafka:9092,
        EXTERNAL://localhost:9094

      # Maps listener names to their security protocols
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: >
        CONTROLLER:PLAINTEXT,
        PLAINTEXT:PLAINTEXT,
        EXTERNAL:PLAINTEXT

      # Which listener brokers should use for internal communication
      KAFKA_INTER_BROKER_LISTENER_NAME: 'PLAINTEXT'


      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1

      # Speed up consumer group startup
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
      # Auto create topic if they don't already exist
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: 'true'
      KAFKA_NUM_PARTITIONS: 1
        
    volumes:
      - ./docker/kafka_data:/var/lib/kafka/data

  kafka-ui:
    container_name: kafka-ui
    image: ghcr.io/kafbat/kafka-ui:latest
    ports:
      - "8070:8080"
    depends_on:
      - kafka
    environment:
      KAFKA_CLUSTERS_0_NAME: local
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:9092  # Use internal Docker network name
      DYNAMIC_CONFIG_ENABLED: 'true'
    restart: unless-stopped

  influxdb:
    image: influxdb:2.7
    container_name: influxdb
    ports:
      - "8072:8086"
    environment:
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=admin
      - DOCKER_INFLUXDB_INIT_PASSWORD=admin123
      - DOCKER_INFLUXDB_INIT_ORG=chieaid24
      - DOCKER_INFLUXDB_INIT_BUCKET=usage-bucket
      - DOCKER_INFLUXDB_INIT_RETENTION=1w
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=my-token
    volumes:
      - ./influxdb_data:/var/lib/influxdb2
      
      
  mailpit:
    image: axllent/mailpit:latest
    container_name: mailpit
    ports:
      - "8025:8025"
      - "1025:1025"

  ollama:
    image: ollama/ollama:latest
    pull_policy: if_not_present
    container_name: ollama
    ports:
      - "11434:11434"
    volumes:
      - ollama-data:/root/.ollama
    entrypoint: []
    command:
      - /bin/sh
      - -c
      - |
          ollama serve &
          i=0;
          until ollama list >/dev/null 2>&1; do
            i=$$((i+1));
            if [ "$$i" -ge 60 ]; then
              echo "Ollama did not become ready in 60 seconds" >&2;
              exit 1;
            fi;
            sleep 1;
          done;
          ollama pull gemma3:4b;
          wait

  user-service:
    build:
      context: ./services/user-service
    ports:
      - "8080:8080"
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/energy_tracker
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: password
    depends_on:
      mysql:
        condition: service_healthy

  device-service:
    build:
      context: ./services/device-service
    ports:
      - "8081:8081"
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/energy_tracker
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: password
      USER_SERVICE_URL: http://user-service:8080/api/v1/user
    depends_on:
      mysql:
        condition: service_healthy

  ingestion-service:
    build:
      context: ./services/ingestion-service
    ports:
      - "8082:8082"
    environment:
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      INGESTION_ENDPOINT: http://ingestion-service:8082/api/v1/ingestion
      DEVICE_SERVICE_URL: http://device-service:8081/api/v1/device
    depends_on:
      - kafka

  usage-service:
    build:
      context: ./services/usage-service
    ports:
      - "8083:8083"
    environment:
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      INFLUX_URL: http://influxdb:8086
      INFLUX_TOKEN: my-token
      INFLUX_ORG: chieaid24
      INFLUX_BUCKET: usage-bucket
      DEVICE_SERVICE_URL: http://device-service:8081/api/v1/device
      USER_SERVICE_URL: http://user-service:8080/api/v1/user
    depends_on:
      - kafka
      - influxdb
      - device-service
      - user-service

  alert-service:
    build:
      context: ./services/alert-service
    ports:
      - "8084:8084"
    environment:
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/energy_tracker
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: password
      SPRING_MAIL_HOST: mailpit
      SPRING_MAIL_PORT: 1025
    depends_on:
      mysql:
        condition: service_healthy
      kafka:
        condition: service_started
      mailpit:
        condition: service_started

  insight-service:
    build:
      context: ./services/insight-service
    ports:
      - "8085:8085"
    environment:
      USAGE_SERVICE_URL: http://usage-service:8083/api/v1/usage
      SPRING_AI_OLLAMA_BASE_URL: http://ollama:11434
      SPRING_AI_OLLAMA_CHAT_OPTIONS_MODEL: gemma3:4b
    depends_on:
      - usage-service
      - ollama

volumes:
  db-data:
  kafka-data:
  ollama-data:
